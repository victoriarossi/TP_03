///////////////////////////////////////////////////////////////////////////////////////////////////
/* Merge Image tool
	mergeimage.c

	This program is used to merge two binary files.
	Its primary purpose is to take the kernel image file generated by 'createimage' and to
	overwrite that on a fixed-size disk image (perhaps generated by Bochs' bximage).

	This program should be able to merge any two files.

	This work is licensed under the Creative Commons Attribution-NonCommercial-NoDerivatives 4.0
	International License. To view a copy of this license, visit
	http://creativecommons.org/licenses/by-nc-nd/4.0/
	or send a letter to Creative Commons, PO Box 1866, Mountain View, CA 94042, USA.

	Also see http://www.bluekernel.com.au

	copyright Paul Cuttler 2017
 */
///////////////////////////////////////////////////////////////////////////////////////////////////

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "../colors.h"

#define ERROR_OPENING_INFILE				-2
#define ERROR_OPENING_OUTFILE				-3
#define ERROR_INFILE_GREATER_THAN_OUTFILE	-4
#define ERROR_NO_OPTIONS_PROVIDED			-5
#define ERROR_ARGS_NOT_EQUAL_TO_4			-6

int  ConvertOptions(char *options);
int  WriteNumber(int c);
void PrintHelp(int no_args);

FILE	*g_file_in_ptr;
FILE	*g_file_out_ptr;
FILE	*g_file_log_ptr;	// log of output is created in g_log_name
char	*g_log_name = "mergeimage.log";
long	g_pos;
int		append;
int		option_all, option_silent, option_log, option_verbose, option_help;

int main(int argc, char* argv[])
{
	// 0mergeimage 1[options] 2infile 3outfile
	// check arguments
	if (argc != 4)
		PrintHelp(argc);

	ConvertOptions(argv[1]);

	if (option_verbose)
		printf(YELLOW "Merge kernel image %s into %s disk image.\n" NORMAL, argv[2], argv[3]);
			
	g_file_log_ptr = stdout;

	if (option_log) // create log file
	{
		g_file_log_ptr = fopen(g_log_name, "w+b");
		/* read and write binary mode (truncates file to zero length or creates new file).*/
		
		if (g_file_log_ptr == NULL)
		{
			printf("\topen %s failed\n", g_log_name);
			g_file_log_ptr = stdout;
		}
	}
	if (option_help)
		PrintHelp(argc);

	// Open infile
	g_file_in_ptr = fopen(argv[2], "rb"); /*read binary mode*/
	if (g_file_in_ptr == NULL)
	{
		if (option_verbose)
			printf("\tfile %s open failed\n", argv[2]);
		
		fclose(g_file_in_ptr);
		exit(ERROR_OPENING_INFILE);
	}

	// Open outfile
	g_file_out_ptr = fopen(argv[3], "r+b");
	/* Open the outfile. Read and write binary mode (truncates file to zero length or creates new file)*/
	
	if (g_file_out_ptr == NULL)
	{
		if (option_verbose)
			printf("\topen %s failed.\nFile must be 10MB generated for Bochs emulator. Do not delete or clean.\n",argv[3]);
		
		exit(ERROR_OPENING_OUTFILE);
	}
	
	// Determine size of files, print size to file block.
	fseek(g_file_in_ptr, 0, SEEK_END);
	int pos_in = ftell(g_file_in_ptr);
	fseek(g_file_in_ptr, 0, SEEK_SET);
	
	fseek(g_file_out_ptr, 0, SEEK_END);
	int pos_out = ftell(g_file_out_ptr);
	fseek(g_file_out_ptr, 0, SEEK_SET);
	
	printf("\tinput %s is %dKB, output %s is %dKB.\n", argv[2], pos_in/1024, argv[3], pos_out/1024);
	
	if (pos_in > pos_out)
	{
		printf("input file should be no bigger than output.\n");
		exit(ERROR_INFILE_GREATER_THAN_OUTFILE);
	}
	
	int c	= 0;
	c		= fgetc(g_file_in_ptr);
	
	while (c != EOF)
	{
		fputc(c, g_file_out_ptr);
		c = fgetc(g_file_in_ptr);
	}

	fclose(g_file_in_ptr);
	fclose(g_file_out_ptr);
	
	if (g_file_log_ptr != stdout)
		fclose(g_file_log_ptr);
	
	return 0;
}

int ConvertOptions(char *options)
{
	option_all = option_log = option_verbose = option_help = 0;
	
	if (options[0] != '-')
		exit(ERROR_NO_OPTIONS_PROVIDED);
	
	else
	{
		int i = 0;
		while (options[i] != 0)
		{
			switch (options[i])
			{
				case 'a' : option_all = option_log = option_verbose = option_help = 1; break;
				case 'l' : option_log = 1; break;
				case 's' : option_silent = 1; break;
				case 'v' : option_verbose = 1; break;
				case 'h' : option_help = 1; break;
			}
			i++;
		}
	}
	
	return 1;
}


int WriteNumber(int c)
{
	int number_ascii[4];
	number_ascii[0] = c			& 0xFF;
	number_ascii[1] = (c >> 8)	& 0x00FF;
	number_ascii[2] = (c >> 16)	& 0x0000FF;
	number_ascii[3] = (c >> 24)	& 0x000000FF;
	
	for(int i = 0; i < 4; i++)
		fputc(number_ascii[i], g_file_out_ptr);
	
	return 1;
}

void PrintHelp(int no_args)
{
	printf("mergeimage [options] infile outfile\n");
	printf("\toptions:\n\t-s silent (don't display anything, don't produce log file.\n\t-v verbose (prints messages on stdout\n\t-l outputs messages log file 'mergeimage.log'\n\t-h this help\n");
	printf("\tNB: the options are not optional!\n");
	
	if (no_args != 4)
	{
		printf("\tError: wrong number of arguments (you gave %d).\n", no_args - 1);
		exit(ERROR_ARGS_NOT_EQUAL_TO_4);
	}
}
